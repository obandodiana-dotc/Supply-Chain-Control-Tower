<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SupplyChain Intelligence · ABC Clustering</title>

<style>
  :root {
    --bg: #0a0f1c;
    --card: #131b2f;
    --soft: #1c2640;
    --accent: #38bdf8;
    --accent2: #34d399;
    --warn: #facc15;
    --danger: #fb7185;
    --text: #e2e8f0;
    --text-soft: #94a3b8;
    --radius: 18px;
    --radius-sm: 10px;
    --font: system-ui, sans-serif;
  }

  * { margin:0; padding:0; box-sizing:border-box; font-family:var(--font); }

  body {
    background: var(--bg);
    color: var(--text);
    padding-bottom: 50px;
  }

  /* NAV BAR */
  nav {
    width: 100%;
    background: var(--card);
    padding: 14px;
    display: flex;
    justify-content: center;
    gap: 22px;
    position: sticky;
    top: 0;
    z-index: 99;
    border-bottom: 1px solid #1e293b;
  }
  nav a {
    color: var(--text-soft);
    text-decoration: none;
    font-weight: 500;
  }
  nav a:hover { color: var(--accent); }

  .container {
    max-width: 960px;
    margin: auto;
    padding: 20px;
  }

  h1 {
    text-align: center;
    font-size: 32px;
    margin-bottom: 6px;
    background: linear-gradient(to right, #38bdf8, #a855f7, #f97316);
    -webkit-background-clip: text;
    color: transparent;
  }

  .subtitle {
    text-align:center;
    font-size:14px;
    color:var(--text-soft);
    margin-bottom:20px;
  }

  .card {
    background: var(--card);
    padding: 16px;
    border-radius: var(--radius);
    border: 1px solid #1e293b;
    margin-top: 24px;
  }

  .card-title {
    font-size:18px;
    margin-bottom:10px;
  }

  .grid-2 {
    display:grid;
    grid-template-columns:1.5fr 1fr;
    gap:16px;
  }
  @media(max-width:800px){
    .grid-2 { grid-template-columns:1fr; }
  }

  table {
    width:100%;
    border-collapse: collapse;
    font-size:12px;
    margin-top:10px;
  }
  th, td {
    border-bottom:1px solid #1e293b;
    padding:6px 6px;
    text-align:right;
    white-space:nowrap;
  }
  th:first-child, td:first-child {
    text-align:left;
  }
  th {
    color:var(--text-soft);
    font-weight:600;
  }
  tbody tr:nth-child(even){
    background:#020617;
  }

  .btn {
    display:inline-block;
    padding:8px 12px;
    border-radius:var(--radius-sm);
    background:var(--accent);
    color:#000;
    font-size:12px;
    font-weight:600;
    border:none;
    cursor:pointer;
    margin-top:6px;
  }

  canvas {
    width:100%;
    height:260px;
    background:#111827;
    border-radius:var(--radius-sm);
    border:1px solid #24314d;
    margin-top:10px;
  }

  .legend {
    margin-top:10px;
    font-size:13px;
    color:var(--text-soft);
    line-height:1.6;
  }
</style>
</head>

<body>

<!-- NAV -->
<nav>
  <a href="index.html">Dashboard</a>
  <a href="inventory.html">Inventory</a>
  <a href="map.html">Network Map</a>
  <a href="simulation.html">Simulation</a>
  <a href="risk.html">Risk</a>
  <a href="abc.html">ABC</a>
</nav>

<div class="container">

  <h1>ABC Clustering</h1>
  <p class="subtitle">Segmentation of SKUs by annual consumption value (Demand × Unit cost)</p>

  <div class="grid-2">
    <!-- LEFT: TABLE -->
    <div class="card">
      <div class="card-title">SKU List & ABC Classes</div>
      <button class="btn" onclick="calculateABC()">Recalculate ABC</button>
      <table>
        <thead>
          <tr>
            <th>SKU</th>
            <th>Annual Demand</th>
            <th>Unit Cost</th>
            <th>Annual Value</th>
            <th>Cumulative %</th>
            <th>Class</th>
          </tr>
        </thead>
        <tbody id="abcTableBody"></tbody>
      </table>
    </div>

    <!-- RIGHT: DONUT CHART -->
    <div class="card">
      <div class="card-title">ABC Distribution</div>
      <canvas id="abcChart"></canvas>
      <div class="legend" id="abcLegend"></div>
    </div>
  </div>

</div>

<script src="data.js"></script>

<script>
const canvas = document.getElementById("abcChart");
const ctx = canvas.getContext("2d");
const tbody = document.getElementById("abcTableBody");
const legend = document.getElementById("abcLegend");

function calculateABC() {
  // 1) Enriquecer SKUs con annualValue
  const items = SKUs.map(s => ({
    id: s.id,
    name: s.name,
    demand: s.demandAnnual,
    unitCost: s.unitCost,
    value: s.demandAnnual * s.unitCost
  }));

  // 2) Ordenar por valor desc
  items.sort((a,b) => b.value - a.value);

  // 3) Cálculo de % acumulado y clases A/B/C
  const totalValue = items.reduce((sum, s) => sum + s.value, 0);
  let cumulative = 0;

  items.forEach(item => {
    cumulative += item.value;
    const share = totalValue ? cumulative / totalValue : 0;
    item.cumShare = share;

    if (share <= ABC_thresholds.A) {
      item.cls = "A";
    } else if (share <= ABC_thresholds.B) {
      item.cls = "B";
    } else {
      item.cls = "C";
    }
  });

  renderTable(items);
  renderDonut(items);
}

function renderTable(items) {
  tbody.innerHTML = "";
  items.forEach(item => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.id}</td>
      <td>${item.demand.toLocaleString()}</td>
      <td>€${item.unitCost.toFixed(2)}</td>
      <td>€${item.value.toLocaleString(undefined,{maximumFractionDigits:0})}</td>
      <td>${(item.cumShare*100).toFixed(1)}%</td>
      <td>${item.cls}</td>
    `;
    tbody.appendChild(tr);
  });
}

function renderDonut(items) {
  const counts = { A: 0, B: 0, C: 0 };
  items.forEach(i => counts[i.cls]++);

  const total = items.length || 1;
  const fracA = counts.A / total;
  const fracB = counts.B / total;
  const fracC = counts.C / total;

  // Config canvas
  const width = canvas.clientWidth;
  const height = canvas.clientHeight;
  canvas.width = width * 2;
  canvas.height = height * 2;
  ctx.scale(2,2);

  ctx.clearRect(0, 0, width, height);

  const cx = width / 2;
  const cy = height / 2;
  const outerR = Math.min(width, height) / 2 - 10;
  const innerR = outerR * 0.55;

  let start = -Math.PI / 2;

  function drawSegment(frac, color) {
    if (frac <= 0) return;
    const end = start + frac * Math.PI * 2;
    ctx.beginPath();
    ctx.arc(cx, cy, outerR, start, end);
    ctx.arc(cx, cy, innerR, end, start, true);
    ctx.closePath();
    ctx.fillStyle = color;
    ctx.fill();
    start = end;
  }

  drawSegment(fracA, "#38bdf8"); // A
  drawSegment(fracB, "#22c55e"); // B
  drawSegment(fracC, "#f97316"); // C

  // Texto en el centro
  ctx.fillStyle = "#e5e7eb";
  ctx.font = "14px system-ui";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText("ABC", cx, cy);

  // Leyenda
  legend.innerHTML = `
    <strong>Class A:</strong> ${counts.A} SKUs · ~Top ${ABC_thresholds.A*100}% of value<br>
    <strong>Class B:</strong> ${counts.B} SKUs · Up to ${ABC_thresholds.B*100}% of value<br>
    <strong>Class C:</strong> ${counts.C} SKUs · Remaining tail of portfolio
  `;
}

// inicial
calculateABC();
</script>

</body>
</html>
